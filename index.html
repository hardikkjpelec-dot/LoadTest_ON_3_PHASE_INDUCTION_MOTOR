<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Practical 4 – Direct Load Test (3Φ Induction Motor)</title>

  <!-- Chart.js (graph) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0c1730;
      --text:#eaf0ff;
      --muted:#b8c3e6;
      --line:rgba(255,255,255,.12);
      --accent:#6aa7ff;
      --accent2:#7cf0c5;
      --warn:#ffcc66;
      --danger:#ff6a8a;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(106,167,255,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 0%, rgba(124,240,197,.18), transparent 55%),
        radial-gradient(900px 800px at 70% 120%, rgba(255,204,102,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }

    header{
      padding:22px 22px 10px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.55));
      backdrop-filter: blur(10px);
      z-index:10;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      font-weight:750;
      letter-spacing:.2px;
    }
    .title .sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
      line-height:1.3;
    }
    .pillrow{display:flex; gap:10px; flex-wrap:wrap}
    .pill{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--text); font-weight:700}
    .container{
      padding:18px 22px 30px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 1020px){
      .container{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd .h{
      font-weight:750;
      font-size:14px;
      letter-spacing:.15px;
      margin:0;
    }
    .card .bd{padding:14px}
    .muted{color:var(--muted)}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap}
    button{
      appearance:none;
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      color:var(--text);
      background:rgba(106,167,255,.18);
      border:1px solid rgba(106,167,255,.35);
      cursor:pointer;
      transition: transform .08s ease, background .12s ease;
    }
    button:hover{transform: translateY(-1px); background:rgba(106,167,255,.23)}
    button:active{transform: translateY(0px)}
    .btn2{
      background:rgba(124,240,197,.14);
      border:1px solid rgba(124,240,197,.35);
    }
    .btn3{
      background:rgba(255,204,102,.12);
      border:1px solid rgba(255,204,102,.35);
    }
    .btnDanger{
      background:rgba(255,106,138,.12);
      border:1px solid rgba(255,106,138,.35);
    }
    .mini{
      padding:8px 10px;
      font-size:12px;
      border-radius:10px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){ .grid2{grid-template-columns:1fr} }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-family:var(--sans);
    }
    input::placeholder{color:rgba(184,195,230,.55)}
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      line-height:1.35;
    }

    /* Observation table */
    .tableWrap{overflow:auto; border-radius:16px; border:1px solid var(--line)}
    table{
      border-collapse:collapse;
      width:100%;
      min-width: 980px;
      background:rgba(0,0,0,.18);
    }
    th, td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 10px;
      text-align:left;
      vertical-align:middle;
      font-size:12px;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background:rgba(15,27,51,.95);
      z-index:1;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    td input{
      min-width: 105px;
      padding:8px 8px;
      border-radius:10px;
      font-size:12px;
      background:rgba(0,0,0,.18);
    }
    td .out{
      font-family:var(--mono);
      font-size:12px;
      color:var(--text);
    }
    .right{display:flex; justify-content:flex-end}
    .note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      background:rgba(0,0,0,.14);
      font-size:12px;
      line-height:1.35;
    }

    /* Pop-up windows */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
    }
    .window{
      width:min(980px, 95vw);
      max-height: 85vh;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(15,27,51,.95), rgba(9,14,26,.92));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .window.small{width:min(820px, 95vw)}
    .window .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      cursor:move;
      user-select:none;
      gap:10px;
    }
    .window .bar .t{
      font-weight:850;
      font-size:13px;
      letter-spacing:.2px;
      display:flex; gap:10px; align-items:center;
    }
    .window .bar .t span{
      font-family:var(--mono);
      font-weight:700;
      font-size:12px;
      color:var(--muted);
    }
    .window .bar .x{
      border-radius:12px;
      padding:8px 10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900;
      cursor:pointer;
    }
    .window .content{
      padding:12px;
      overflow:auto;
      max-height: calc(85vh - 48px);
    }
    .steps{
      font-family:var(--mono);
      font-size:12px;
      line-height:1.55;
      color:rgba(234,240,255,.92);
      white-space:pre-wrap;
    }
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-bottom:10px;
    }
    @media (max-width: 900px){ .kpiRow{grid-template-columns: repeat(2, 1fr);} }
    .kpi{
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(255,255,255,.04);
    }
    .kpi .k{font-size:11px; color:var(--muted); margin-bottom:6px}
    .kpi .v{font-size:14px; font-weight:900; font-family:var(--mono)}
    .legendNote{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.35;
    }

    /* One-liners */
    .liner{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      line-height:1.45;
      font-size:13px;
    }
    .liner b{color:var(--accent2)}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      font-size:11px;
      color:var(--muted);
    }
    .divider{height:1px; background:rgba(255,255,255,.10); margin:12px 0}
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">
      <h1>Practical 4: Direct Loading Test of 3-Phase Induction Motor</h1>
      <p class="sub">Interactive observation → auto calculation table → step-by-step → graph (Efficiency, PF, Slip, Torque vs BHP)</p>
    </div>
    <div class="pillrow">
      <div class="pill"><b>Pin</b> = W1 + W2</div>
      <div class="pill"><b>Pg</b> = Vg × Ig</div>
      <div class="pill"><b>ηg</b> default 80%</div>
      <div class="pill"><b>Ns</b> = 120f/P</div>
    </div>
  </div>
</header>

<main class="container">
  <!-- LEFT -->
  <section class="card">
    <div class="hd">
      <div class="h">One-liners (Student Friendly)</div>
      <span class="chip" id="linerIndex">1 / 10</span>
    </div>
    <div class="bd">
      <div class="liner" id="linerBox"></div>
      <div class="btnrow" style="margin-top:12px;">
        <button class="mini" id="prevL">◀ Prev</button>
        <button class="mini" id="nextL">Next ▶</button>
        <button class="mini btn3" id="shuffleL">Shuffle</button>
      </div>

      <div class="divider"></div>

      <div class="h" style="margin:0 0 10px 0; font-weight:850;">Experiment Settings</div>
      <div class="grid2">
        <div>
          <label>Supply Frequency f (Hz)</label>
          <input id="freq" type="number" value="50" step="1" />
        </div>
        <div>
          <label>No. of Poles P</label>
          <input id="poles" type="number" value="4" step="1" />
        </div>
        <div>
          <label>Generator efficiency ηg (as %)</label>
          <input id="genEff" type="number" value="80" step="1" />
        </div>
        <div>
          <label>1 HP = (W)</label>
          <input id="hpW" type="number" value="735.5" step="0.1" />
        </div>
      </div>

      <p class="hint">
        Tip: Students enter readings row-wise. Then click <b>Generate Results</b>.
      </p>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <div class="hd">
      <div class="h">Observation Table (Enter readings)</div>
      <div class="btnrow">
        <button class="mini btn2" id="addRow">+ Add Row</button>
        <button class="mini btnDanger" id="clearAll">Clear</button>
        <button class="mini" id="generate">Generate Results</button>
      </div>
    </div>

    <div class="bd">
      <div class="tableWrap">
        <table id="obsTable">
          <thead>
            <tr>
              <th>Sr</th>
              <th>V (Line) (V)</th>
              <th>I (Line) (A)</th>
              <th>W1 (W)</th>
              <th>W2 (W)</th>
              <th>Vg (V)</th>
              <th>Ig (A)</th>
              <th>N (rpm)</th>
              <th class="right">Pin=W1+W2</th>
              <th class="right">Pg=Vg×Ig</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="note">
        <b>Auto preview:</b> Pin and Pg show immediately. Final outputs (ηm, PF, BHP, Torque, Slip) appear after Generate.
      </div>
    </div>
  </section>
</main>

<!-- Modal 1: Calculation Table -->
<div class="modal" id="mCalc">
  <div class="window" id="wCalc">
    <div class="bar" data-drag="wCalc">
      <div class="t">Calculation Table <span>(computed from observations)</span></div>
      <div class="x" data-close="mCalc">✕</div>
    </div>
    <div class="content">
      <div class="kpiRow" id="kpiRow"></div>
      <div class="tableWrap">
        <table id="calcTable">
          <thead>
            <tr>
              <th>Sr</th>
              <th class="right">Pin (W)</th>
              <th class="right">Pg (W)</th>
              <th class="right">Pout_motor (W)</th>
              <th class="right">ηmotor (%)</th>
              <th class="right">PF (cosφ)</th>
              <th class="right">BHP</th>
              <th class="right">Torque (N·m)</th>
              <th class="right">Slip (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="legendNote">
        Assumptions: Generator efficiency ηg is applied to convert electrical Pg to motor shaft output (Pout_motor = Pg/ηg).
        Slip uses Ns = 120f/P.
      </div>
    </div>
  </div>
</div>

<!-- Modal 2: Step-by-step -->
<div class="modal" id="mSteps">
  <div class="window small" id="wSteps">
    <div class="bar" data-drag="wSteps">
      <div class="t">Step-by-Step Calculation <span>(for selected row)</span></div>
      <div class="x" data-close="mSteps">✕</div>
    </div>
    <div class="content">
      <div class="grid2" style="margin-bottom:10px;">
        <div>
          <label>Select row</label>
          <select id="rowPick"></select>
        </div>
        <div>
          <label>Show details</label>
          <select id="detailMode">
            <option value="full">Full (with substitution)</option>
            <option value="formula">Only formulas</option>
          </select>
        </div>
      </div>
      <div class="steps" id="stepsBox"></div>
    </div>
  </div>
</div>

<!-- Modal 3: Graph -->
<div class="modal" id="mGraph">
  <div class="window" id="wGraph">
    <div class="bar" data-drag="wGraph">
      <div class="t">Graph <span>(Performance vs BHP)</span></div>
      <div class="x" data-close="mGraph">✕</div>
    </div>
    <div class="content">
      <div class="grid2" style="margin-bottom:10px;">
        <div>
          <label>Y-axis series</label>
          <select id="seriesPick">
            <option value="eta">Efficiency (%)</option>
            <option value="pf">Power factor</option>
            <option value="slip">Slip (%)</option>
            <option value="torque">Torque (N·m)</option>
          </select>
        </div>
        <div>
          <label>Chart type</label>
          <select id="chartType">
            <option value="line">Line</option>
            <option value="scatter">Scatter</option>
          </select>
        </div>
      </div>
      <canvas id="chart" height="120"></canvas>
      <div class="legendNote">
        X-axis = BHP (motor). Change series to show different curves.
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- One-liners ----------
  const oneLiners = [
    "Two-wattmeter method: <b>Pin = W1 + W2</b> (total 3-phase input power).",
    "If load increases, current increases, and the motor draws more real power.",
    "Generator electrical output: <b>Pg = Vg × Ig</b> (DC output to lamp load).",
    "Motor shaft output is estimated from generator output using ηg: <b>Pout_motor = Pg / ηg</b>.",
    "Motor efficiency: <b>η = (Pout_motor / Pin) × 100</b>.",
    "Power factor from readings: <b>cosφ = Pin / (√3 V I)</b>.",
    "Synchronous speed: <b>Ns = 120 f / P</b> (rpm).",
    "Slip shows how much rotor lags the rotating field: <b>s% = (Ns − N)/Ns × 100</b>.",
    "BHP converts watts to horsepower: <b>BHP = Pout_motor / 735.5</b> (commonly used in lab sheets).",
    "Torque from power and speed (lab form): <b>T = (BHP × 4500)/(2πN)</b>."
  ];
  let linerPos = 0;

  const linerBox = document.getElementById("linerBox");
  const linerIndex = document.getElementById("linerIndex");
  function renderLiner(){
    linerBox.innerHTML = oneLiners[linerPos];
    linerIndex.textContent = `${linerPos+1} / ${oneLiners.length}`;
  }
  document.getElementById("prevL").onclick = () => { linerPos = (linerPos - 1 + oneLiners.length) % oneLiners.length; renderLiner(); };
  document.getElementById("nextL").onclick = () => { linerPos = (linerPos + 1) % oneLiners.length; renderLiner(); };
  document.getElementById("shuffleL").onclick = () => { linerPos = Math.floor(Math.random()*oneLiners.length); renderLiner(); };
  renderLiner();

  // ---------- Observation table ----------
  const tbody = document.querySelector("#obsTable tbody");

  function num(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
  function fmt(v, d=2){
    if(!Number.isFinite(v)) return "—";
    return (Math.round(v*10**d)/10**d).toFixed(d);
  }

  function addRow(pref={}){
    const tr = document.createElement("tr");
    const sr = tbody.children.length + 1;

    tr.innerHTML = `
      <td class="out">${sr}</td>
      <td><input type="number" step="0.1" placeholder="V" value="${pref.V ?? ""}"></td>
      <td><input type="number" step="0.01" placeholder="I" value="${pref.I ?? ""}"></td>
      <td><input type="number" step="0.1" placeholder="W1" value="${pref.W1 ?? ""}"></td>
      <td><input type="number" step="0.1" placeholder="W2" value="${pref.W2 ?? ""}"></td>
      <td><input type="number" step="0.1" placeholder="Vg" value="${pref.Vg ?? ""}"></td>
      <td><input type="number" step="0.01" placeholder="Ig" value="${pref.Ig ?? ""}"></td>
      <td><input type="number" step="1" placeholder="N" value="${pref.N ?? ""}"></td>
      <td class="right out" data-pin>—</td>
      <td class="right out" data-pg>—</td>
    `;

    // auto preview Pin/Pg
    const inputs = tr.querySelectorAll("input");
    inputs.forEach(inp => inp.addEventListener("input", () => previewRow(tr)));
    tbody.appendChild(tr);
    previewRow(tr);
  }

  function previewRow(tr){
    const tds = tr.querySelectorAll("td");
    const V  = num(tds[1].querySelector("input").value);
    const I  = num(tds[2].querySelector("input").value);
    const W1 = num(tds[3].querySelector("input").value);
    const W2 = num(tds[4].querySelector("input").value);
    const Vg = num(tds[5].querySelector("input").value);
    const Ig = num(tds[6].querySelector("input").value);

    const Pin = W1 + W2;
    const Pg = Vg * Ig;

    tr.querySelector("[data-pin]").textContent = Pin ? fmt(Pin,1) : "—";
    tr.querySelector("[data-pg]").textContent  = Pg ? fmt(Pg,1)  : "—";
  }

  document.getElementById("addRow").onclick = () => addRow();
  document.getElementById("clearAll").onclick = () => {
    tbody.innerHTML = "";
    addRow();
    addRow();
  };

  // start with 2 rows
  addRow();
  addRow();

  // ---------- Computation ----------
  function getSettings(){
    const f = num(document.getElementById("freq").value) || 50;
    const P = num(document.getElementById("poles").value) || 4;
    const etaG = (num(document.getElementById("genEff").value) || 80) / 100;
    const hpW = num(document.getElementById("hpW").value) || 735.5;
    const Ns = (120 * f) / P;
    return {f, P, etaG, hpW, Ns};
  }

  function readRows(){
    const {etaG, hpW, Ns} = getSettings();
    const rows = [];
    [...tbody.children].forEach((tr, i) => {
      const tds = tr.querySelectorAll("td");
      const V  = num(tds[1].querySelector("input").value);
      const I  = num(tds[2].querySelector("input").value);
      const W1 = num(tds[3].querySelector("input").value);
      const W2 = num(tds[4].querySelector("input").value);
      const Vg = num(tds[5].querySelector("input").value);
      const Ig = num(tds[6].querySelector("input").value);
      const N  = num(tds[7].querySelector("input").value);

      const Pin = W1 + W2;
      const Pg  = Vg * Ig;
      const Pout = etaG > 0 ? (Pg / etaG) : 0;             // motor shaft output (W)
      const etaM = Pin > 0 ? (Pout / Pin) * 100 : 0;       // %
      const pf   = (V>0 && I>0) ? Pin / (Math.sqrt(3)*V*I) : 0;
      const bhp  = hpW > 0 ? (Pout / hpW) : 0;
      const torque = (N>0) ? (bhp * 4500) / (2*Math.PI*N) : 0;
      const slip = (Ns>0) ? ((Ns - N)/Ns)*100 : 0;

      rows.push({sr:i+1, V, I, W1, W2, Vg, Ig, N, Pin, Pg, Pout, etaM, pf, bhp, torque, slip});
    });
    return rows;
  }

  // ---------- Modal wiring (3 pop-ups) ----------
  function openModal(id){ document.getElementById(id).style.display = "flex"; }
  function closeModal(id){ document.getElementById(id).style.display = "none"; }

  document.querySelectorAll("[data-close]").forEach(x=>{
    x.addEventListener("click", e => closeModal(e.currentTarget.getAttribute("data-close")));
  });

  // Drag windows
  const dragState = {active:false, wid:null, startX:0, startY:0, startLeft:0, startTop:0};
  document.querySelectorAll(".bar[data-drag]").forEach(bar=>{
    bar.addEventListener("mousedown", (e)=>{
      const wid = bar.getAttribute("data-drag");
      const w = document.getElementById(wid);
      dragState.active = true;
      dragState.wid = wid;
      dragState.startX = e.clientX;
      dragState.startY = e.clientY;
      const rect = w.getBoundingClientRect();
      dragState.startLeft = rect.left;
      dragState.startTop = rect.top;
      w.style.position = "fixed";
      w.style.left = rect.left + "px";
      w.style.top  = rect.top  + "px";
      w.style.margin = "0";
    });
  });
  window.addEventListener("mousemove", (e)=>{
    if(!dragState.active) return;
    const w = document.getElementById(dragState.wid);
    const dx = e.clientX - dragState.startX;
    const dy = e.clientY - dragState.startY;
    w.style.left = (dragState.startLeft + dx) + "px";
    w.style.top  = (dragState.startTop + dy) + "px";
  });
  window.addEventListener("mouseup", ()=> dragState.active = false);

  // ---------- Fill Calculation Table ----------
  function fillCalc(rows){
    const tb = document.querySelector("#calcTable tbody");
    tb.innerHTML = "";

    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="out">${r.sr}</td>
        <td class="right out">${r.Pin ? fmt(r.Pin,1) : "—"}</td>
        <td class="right out">${r.Pg ? fmt(r.Pg,1) : "—"}</td>
        <td class="right out">${r.Pout ? fmt(r.Pout,1) : "—"}</td>
        <td class="right out">${r.etaM ? fmt(r.etaM,2) : "—"}</td>
        <td class="right out">${r.pf ? fmt(r.pf,3) : "—"}</td>
        <td class="right out">${r.bhp ? fmt(r.bhp,3) : "—"}</td>
        <td class="right out">${r.torque ? fmt(r.torque,3) : "—"}</td>
        <td class="right out">${Number.isFinite(r.slip) ? fmt(r.slip,2) : "—"}</td>
      `;
      tb.appendChild(tr);
    });

    // KPIs (best row)
    const valid = rows.filter(r => r.Pin>0 && r.Pg>0);
    const kpiRow = document.getElementById("kpiRow");
    kpiRow.innerHTML = "";
    if(valid.length){
      const bestEta = valid.reduce((a,b)=> (b.etaM>a.etaM ? b : a), valid[0]);
      const maxBHP  = valid.reduce((a,b)=> (b.bhp>a.bhp ? b : a), valid[0]);
      const bestPF  = valid.reduce((a,b)=> (b.pf>a.pf ? b : a), valid[0]);
      const {Ns} = getSettings();

      const cards = [
        {k:"Max Efficiency", v:`${fmt(bestEta.etaM,2)} % (Row ${bestEta.sr})`},
        {k:"Max BHP", v:`${fmt(maxBHP.bhp,3)} (Row ${maxBHP.sr})`},
        {k:"Best Power Factor", v:`${fmt(bestPF.pf,3)} (Row ${bestPF.sr})`},
        {k:"Synchronous Speed Ns", v:`${fmt(Ns,0)} rpm`}
      ];
      cards.forEach(c=>{
        const d = document.createElement("div");
        d.className = "kpi";
        d.innerHTML = `<div class="k">${c.k}</div><div class="v">${c.v}</div>`;
        kpiRow.appendChild(d);
      });
    } else {
      const d = document.createElement("div");
      d.className = "note";
      d.innerHTML = "Enter at least one valid row (W1, W2, Vg, Ig) to generate calculations.";
      kpiRow.appendChild(d);
    }
  }

  // ---------- Step-by-step ----------
  function fillRowPick(rows){
    const sel = document.getElementById("rowPick");
    sel.innerHTML = "";
    rows.forEach(r=>{
      const o = document.createElement("option");
      o.value = r.sr;
      o.textContent = `Row ${r.sr}`;
      sel.appendChild(o);
    });
  }

  function buildSteps(r){
    const {etaG, hpW, Ns} = getSettings();
    const mode = document.getElementById("detailMode").value;

    const etaGpct = etaG * 100;
    const lines = [];

    lines.push(`Given (Row ${r.sr}):`);
    lines.push(`V = ${r.V} V, I = ${r.I} A, W1 = ${r.W1} W, W2 = ${r.W2} W, Vg = ${r.Vg} V, Ig = ${r.Ig} A, N = ${r.N} rpm`);
    lines.push("");

    lines.push(`1) Input power (Two-wattmeter):`);
    lines.push(`   Pin = W1 + W2`);
    if(mode==="full") lines.push(`   Pin = ${r.W1} + ${r.W2} = ${fmt(r.Pin,1)} W`);
    lines.push("");

    lines.push(`2) Generator electrical output:`);
    lines.push(`   Pg = Vg × Ig`);
    if(mode==="full") lines.push(`   Pg = ${r.Vg} × ${r.Ig} = ${fmt(r.Pg,1)} W`);
    lines.push("");

    lines.push(`3) Motor shaft output (assume generator efficiency ηg = ${etaGpct}%):`);
    lines.push(`   Pout_motor = Pg / ηg`);
    if(mode==="full") lines.push(`   Pout_motor = ${fmt(r.Pg,1)} / ${etaG.toFixed(2)} = ${fmt(r.Pout,1)} W`);
    lines.push("");

    lines.push(`4) Motor efficiency:`);
    lines.push(`   ηmotor = (Pout_motor / Pin) × 100`);
    if(mode==="full") lines.push(`   ηmotor = (${fmt(r.Pout,1)} / ${fmt(r.Pin,1)}) × 100 = ${fmt(r.etaM,2)} %`);
    lines.push("");

    lines.push(`5) Power factor:`);
    lines.push(`   cosφ = Pin / (√3 × V × I)`);
    if(mode==="full") lines.push(`   cosφ = ${fmt(r.Pin,1)} / (1.732 × ${r.V} × ${r.I}) = ${fmt(r.pf,3)}`);
    lines.push("");

    lines.push(`6) BHP (using 1 HP = ${hpW} W):`);
    lines.push(`   BHP = Pout_motor / ${hpW}`);
    if(mode==="full") lines.push(`   BHP = ${fmt(r.Pout,1)} / ${hpW} = ${fmt(r.bhp,3)}`);
    lines.push("");

    lines.push(`7) Torque (lab form):`);
    lines.push(`   T = (BHP × 4500) / (2πN)`);
    if(mode==="full") lines.push(`   T = (${fmt(r.bhp,3)} × 4500) / (2×3.1416×${r.N}) = ${fmt(r.torque,3)} N·m`);
    lines.push("");

    lines.push(`8) Slip:`);
    lines.push(`   Ns = ${fmt(Ns,0)} rpm`);
    lines.push(`   s% = ((Ns − N)/Ns) × 100`);
    if(mode==="full") lines.push(`   s% = ((${fmt(Ns,0)} − ${r.N})/${fmt(Ns,0)}) × 100 = ${fmt(r.slip,2)} %`);

    return lines.join("\n");
  }

  // ---------- Graph ----------
  let chart;
  function buildChart(rows){
    const series = document.getElementById("seriesPick").value;
    const type = document.getElementById("chartType").value;

    const pts = rows
      .filter(r=> r.bhp>0 && Number.isFinite(r.bhp))
      .map(r=>{
        let y = 0;
        if(series==="eta") y = r.etaM;
        if(series==="pf") y = r.pf;
        if(series==="slip") y = r.slip;
        if(series==="torque") y = r.torque;
        return {x:r.bhp, y:y, sr:r.sr};
      });

    const labelMap = {
      eta:"Efficiency (%)",
      pf:"Power factor",
      slip:"Slip (%)",
      torque:"Torque (N·m)"
    };

    const ctx = document.getElementById("chart").getContext("2d");
    if(chart) chart.destroy();

    chart = new Chart(ctx, {
      type: type,
      data: {
        datasets: [{
          label: labelMap[series],
          data: pts
        }]
      },
      options: {
        responsive:true,
        parsing:false,
        plugins:{
          tooltip:{
            callbacks:{
              label: (c)=> `Row ${c.raw.sr}: (BHP=${c.raw.x.toFixed(3)}, Y=${c.raw.y.toFixed(3)})`
            }
          },
          legend:{labels:{color:"rgba(234,240,255,.9)"}}
        },
        scales:{
          x:{title:{display:true, text:"BHP", color:"rgba(234,240,255,.9)"}, ticks:{color:"rgba(234,240,255,.75)"}},
          y:{title:{display:true, text:labelMap[series], color:"rgba(234,240,255,.9)"}, ticks:{color:"rgba(234,240,255,.75)"}}
        }
      }
    });
  }

  // Update chart when dropdown changes (if modal is open)
  document.getElementById("seriesPick").addEventListener("change", ()=>{
    const rows = readRows(); buildChart(rows);
  });
  document.getElementById("chartType").addEventListener("change", ()=>{
    const rows = readRows(); buildChart(rows);
  });

  // Steps update on row selection
  document.getElementById("rowPick").addEventListener("change", ()=>{
    const rows = readRows();
    const sr = num(document.getElementById("rowPick").value);
    const r = rows.find(x=>x.sr===sr);
    document.getElementById("stepsBox").textContent = r ? buildSteps(r) : "";
  });
  document.getElementById("detailMode").addEventListener("change", ()=>{
    const rows = readRows();
    const sr = num(document.getElementById("rowPick").value);
    const r = rows.find(x=>x.sr===sr);
    document.getElementById("stepsBox").textContent = r ? buildSteps(r) : "";
  });

  // ---------- Generate button ----------
  document.getElementById("generate").onclick = ()=>{
    const rows = readRows();

    // Fill all three windows
    fillCalc(rows);
    fillRowPick(rows);

    // default selected row = first row
    document.getElementById("rowPick").value = rows.length ? rows[0].sr : 1;
    document.getElementById("stepsBox").textContent = rows.length ? buildSteps(rows[0]) : "";

    buildChart(rows);

    // Open all 3 pop-up windows (modals)
    openModal("mCalc");
    openModal("mSteps");
    openModal("mGraph");
  };

  // Clicking outside closes that modal
  ["mCalc","mSteps","mGraph"].forEach(id=>{
    const m = document.getElementById(id);
    m.addEventListener("click", (e)=>{
      if(e.target === m) closeModal(id);
    });
  });
</script>
</body>
</html>
